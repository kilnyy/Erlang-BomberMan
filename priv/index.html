<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <title>Websocket client</title>
    <script src="/static/jquery.min.js"></script>
    <script type="text/javascript">
      
    var websocket;
    $(document).ready(init);
    var players = {};
    var grid = 10;
    var width = 800;
    var height = 600;
    var interval = 40;
    var delayTime = 0;

    function Player(id, x, y, dx, dy) {
      this.id = id;
      this.x = x;
      this.y = y;
      this.dx = dx;
      this.dy = dy;
      players[this.id] = this;

      this.run = function() {
        this.x = this.x + this.dx * interval / 1000;
        this.y = this.y + this.dy * interval / 1000;
        context.fillStyle="#eee";
        context.fillRect(this.x*grid + width/2 - grid/2, this.y*grid + height/2 - grid/2, grid, grid);
      }

      this.move = function(dx, dy, x, y, timestamp) {
        this.dx = dx;
        this.dy = dy;
        if (player && this != player) {
          cur = curTime();
          this.x = x + dx * (cur - timestamp) / 1000;
          this.y = y + dy * (cur - timestamp) / 1000;
        }
      }
    }
    
    function init() {
      if(!("WebSocket" in window)){  
        console.log("websocket do not support");
      } else {
        connect();
      };

      canvas=document.getElementById("canvas");
      context=canvas.getContext('2d');


      function drawBackground() {
        context.clearRect(0, 0, width, height);
        context.fillStyle="#000";
        context.fillRect(0, 0, width, height);
      }

      var run = function() {
          drawBackground();
          for (var i in players) {
            players[i].run();
          }
      }
      var stop = setInterval(run, interval);
      canvas.width = width;
      canvas.height = height;
    };

    function connect()
    {
      var url = location.href;
      wsHost = url.replace('http:', 'ws:') + 'websocket';
      websocket = new WebSocket(wsHost);
      websocket.onopen = function(evt) { onOpen(evt) }; 
      websocket.onclose = function(evt) { onClose(evt) }; 
      websocket.onmessage = function(evt) { onMessage(evt) }; 
      websocket.onerror = function(evt) { onError(evt) }; 
    };  

    function curTime() {
      return new Date().getTime() + delayTime;
    }
    
    function send(data) {
      data.push(curTime());
      var txt = JSON.stringify(data);
      if(websocket.readyState == websocket.OPEN){
        websocket.send(txt);
        console.log('sending: ' + txt); 
      } else {
         console.log('websocket is not connected'); 
      };
    };

    function onOpen(evt) { 
      console.log("connected");
    };  

    function onClose(evt) { 
      console.log("disconnected");
    };  

    function onMessage(evt) { 
    console.log("receive: " + evt.data);
        data = JSON.parse(evt.data);
      if (data[0] == 'player' && data[1] == 'move') {
        id = data[2]; x = data[3]; y = data[4]; dx = data[5]; dy = data[6];
        timestamp = data[7];
        if (players[id]) players[id].move(dx, dy, x, y, timestamp);
        else new Player(id, x, y, dx, dy);
      }
      if (data[0] == 'player' && data[1] == 'init') {
        id = data[2];
        player = new Player(id, 0, 0, 0, 0);
        send(['time']);
      }
      if (data[0] == 'time') {
        delayTime = parseInt((curTime() - data[1]) / 2);
      }
    };  

    function onError(evt) {
      console.log("error: " + evt.data);
    };

    document.onkeydown = function(event) {
      if (!player) return;
      var dx, dy;
      if (event.which == 'A'.charCodeAt(0) || event.which == 'D'.charCodeAt(0)) {
        dx = (event.which == 'A'.charCodeAt(0)) ? -1 : 1;
      } else {
        dx = 0;
      }
      if (event.which == 'W'.charCodeAt(0) || event.which == 'S'.charCodeAt(0)) {
        dy = (event.which == 'W'.charCodeAt(0)) ? -1 : 1;
      } else {
        dy = 0;
      }
      if (dx || dy) {
        dx *= 5;
        dy *= 5;
        player.move(dx, dy);
        send(["player", "move", player.x, player.y, dx, dy]);
      }
    }

    document.onkeyup = function(event) {
      if (!player) return;
      if (event.which == 'A'.charCodeAt(0) || event.which == 'D'.charCodeAt(0) 
          || event.which == 'W'.charCodeAt(0) || event.which == 'S'.charCodeAt(0)) {
        player.move(0, 0);
        send(["player", "move", player.x, player.y, 0, 0]);
      }
    }

    </script>
  </head>

  <body style="  margin: 50px auto;width: 800px; ">
    <canvas id="canvas"></canvas>
  </body>
</html> 
